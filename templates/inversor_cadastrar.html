{% extends 'base.html' %}

{% block title %}Cadastrar Inversor – {{ usina.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Cabeçalho + Voltar -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 text-primary">Cadastrar Inversor – {{ usina.nome }}</h2>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('monitoramento_index') }}">
      ← Voltar
    </a>
  </div>

  <!-- Formulário de cadastro -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="post" novalidate>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Serial (inverter_sn) *</label>
            <input type="text"
                   name="inverter_sn"
                   value="{{ form_data.get('inverter_sn','') }}"
                   class="form-control"
                   required
                   placeholder="Ex.: SA1234XYZ5678">
          </div>
          <div class="col-md-4">
            <label class="form-label">Nome (opcional)</label>
            <input type="text"
                   name="nome"
                   value="{{ form_data.get('nome','') }}"
                   class="form-control"
                   placeholder="Ex.: Inversor 01 - Telhado A">
          </div>
          <div class="col-md-4">
            <label class="form-label">Potência (kW) (opcional)</label>
            <input type="number"
                   step="0.001"
                   name="potencia_kw"
                   value="{{ form_data.get('potencia_kw','') }}"
                   class="form-control"
                   placeholder="Ex.: 5.000">
          </div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <button class="btn btn-success">Salvar</button>
          <a class="btn btn-outline-secondary"
             href="{{ url_for('monitoramento_usina', usina_id=usina.id) }}">
            Voltar para Monitoramento
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de inversores já cadastrados -->
    <div class="card shadow-sm">
    <div class="card-header">Inversores cadastrados</div>
    <div class="card-body p-0">
        {% if inversores %}
        <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th>Serial</th>
                <th>Nome</th>
                <th>Potência (kW)</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
            </tr>
            </thead>
            <tbody>
            {% for inv in inversores %}
            <tr>
                <td class="fw-semibold">{{ inv.inverter_sn }}</td>
                <td>{{ inv.nome or '-' }}</td>
                <td>
                {% if inv.potencia_kw is not none %}
                    {{ '%.1f'|format(inv.potencia_kw)|replace('.', ',') }}
                {% else %}-{% endif %}
                </td>
                <td>
                {% if inv.ativo %}
                    <span class="badge bg-success">Ativo</span>
                {% else %}
                    <span class="badge bg-secondary">Inativo</span>
                {% endif %}
                </td>
                <td class="text-end">
                <a class="btn btn-sm btn-outline-primary"
                    href="{{ url_for('editar_inversor_usina', usina_id=usina.id, inv_id=inv.id) }}">
                    Editar
                </a>

                <form method="post"
                        action="{{ url_for('alterar_status_inversor_usina', usina_id=usina.id, inv_id=inv.id) }}"
                        class="d-inline">
                    <button class="btn btn-sm {{ 'btn-warning' if inv.ativo else 'btn-success' }}">
                    {{ 'Inativar' if inv.ativo else 'Ativar' }}
                    </button>
                </form>

                <form method="post"
                        action="{{ url_for('excluir_inversor_usina', usina_id=usina.id, inv_id=inv.id) }}"
                        class="d-inline"
                        onsubmit="return confirm('Excluir o inversor {{ inv.inverter_sn }}? Os monitoramentos existentes não serão alterados.');">
                    <button class="btn btn-sm btn-outline-danger">Excluir</button>
                </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="p-3 text-muted">Nenhum inversor cadastrado para esta usina.</div>
        {% endif %}
    </div>
    </div>

</div>
{% endblock %}
