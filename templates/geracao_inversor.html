{% extends 'base.html' %}

{% block title %}Lançar Geração – {{ usina.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Título + ações -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 text-primary">Lançar Geração – {{ usina.nome }}</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('monitoramento_index') }}">← Voltar ao Monitoramento</a>
      <a class="btn btn-outline-success" href="{{ url_for('cadastrar_inversor_usina', usina_id=usina.id) }}">Cadastrar Inversor</a>
    </div>
  </div>

  <!-- Form de lançamento de geração -->
  <div class="card shadow-sm mb-4">
    <div class="card-header">Inserir geração (kWh)</div>
    <div class="card-body">
      {% if inversores %}
      <form method="post" class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Inversor *</label>
          <select name="inverter_sn" class="form-select" required>
            <option value="">Selecione...</option>
            {% for inv in inversores %}
              <option value="{{ inv.inverter_sn }}">
                {{ inv.inverter_sn }}{% if inv.nome %} – {{ inv.nome }}{% endif %}
                {% if inv.potencia_kw is not none %} ({{ '%.1f'|format(inv.potencia_kw)|replace('.', ',') }} kW){% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" name="data" class="form-control" value="{{ data_ref.strftime('%Y-%m-%d') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Geração (kWh) *</label>
          <input type="text" name="etoday" class="form-control" placeholder="ex.: 21,3" required>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-primary w-100">Salvar</button>
        </div>
      </form>
      {% else %}
        <div class="alert alert-warning mb-0">
          Nenhum inversor ativo cadastrado para esta usina.
          <a href="{{ url_for('cadastrar_inversor_usina', usina_id=usina.id) }}" class="alert-link">Cadastrar agora</a>.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Filtro por dia OU por período -->
  <div class="card shadow-sm mb-3">
    <div class="card-body py-3">
      <form method="get" class="row g-3 align-items-end"
            action="{{ url_for('inserir_geracao_inversor', usina_id=usina.id) }}">

        <div class="col-12">
          <small class="text-muted">
            Se preencher <strong>Data (dia)</strong>, o sistema ignora o intervalo. Se deixar vazio, usa <strong>Período</strong>.
          </small>
        </div>

        <!-- Dia exato -->
        <div class="col-md-3">
          <label class="form-label mb-1">Data (dia)</label>
          <input type="date" name="data" class="form-control"
                 value="{{ data_ref.strftime('%Y-%m-%d') if data_ref }}">
        </div>

        <!-- Intervalo -->
        <div class="col-md-3">
          <label class="form-label mb-1">Período – Início</label>
          <input type="date" name="data_ini" class="form-control"
                 value="{{ data_ini.strftime('%Y-%m-%d') if data_ini }}">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Período – Fim</label>
          <input type="date" name="data_fim" class="form-control"
                 value="{{ data_fim.strftime('%Y-%m-%d') if data_fim }}">
        </div>

        <div class="col-md-3 d-flex gap-2">
          <button class="btn btn-outline-primary flex-grow-1">Aplicar</button>
          <a class="btn btn-outline-secondary"
             href="{{ url_for('inserir_geracao_inversor', usina_id=usina.id) }}">Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Registros -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between flex-wrap gap-2">
      <span>
        {% if data_ini and data_fim %}
          Registros de {{ data_ini.strftime('%d/%m/%Y') }} a {{ data_fim.strftime('%d/%m/%Y') }}
        {% else %}
          Registros de {{ data_ref.strftime('%d/%m/%Y') }}
        {% endif %}
      </span>
      <span class="small text-muted">
        Cadastrados: {{ cadastrados_cnt }} • Com registro: {{ registrados_cnt }} • Soma eToday:
        {{ '%.3f'|format(soma_etoday)|replace('.', ',') }} kWh
      </span>
    </div>

    <div class="card-body p-0">
      {% if registros_dia %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Inversor</th>
                <th>Potência (kW)</th>
                <th>Geração (kWh)</th>
              </tr>
            </thead>
            <tbody>

              {# Intervalo: agrupa por dia #}
              {% if data_ini and data_fim %}
                {% for grupo in registros_dia | groupby('data') %}
                  <tr class="table-secondary">
                    <td colspan="3" class="fw-semibold">
                      {{ grupo.grouper.strftime('%d/%m/%Y') }}
                    </td>
                  </tr>
                  {% for r in grupo.list %}
                    {% set inv = (inversores | selectattr('inverter_sn','equalto', r.inverter_sn) | list | first) %}
                    <tr>
                      <td class="fw-semibold">
                        {{ r.inverter_sn }}{% if inv and inv.nome %} – {{ inv.nome }}{% endif %}
                      </td>
                      <td>
                        {% if r.potencia_kw is not none %}
                          {{ '%.1f'|format(r.potencia_kw)|replace('.', ',') }}
                        {% else %}-{% endif %}
                      </td>
                      <td>
                        {% if r.etoday is not none %}
                          {{ '%.3f'|format(r.etoday)|replace('.', ',') }}
                        {% else %}-{% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                {% endfor %}

              {# Dia único: lista simples #}
              {% else %}
                {% for r in registros_dia %}
                  {% set inv = (inversores | selectattr('inverter_sn','equalto', r.inverter_sn) | list | first) %}
                  <tr>
                    <td class="fw-semibold">
                      {{ r.inverter_sn }}{% if inv and inv.nome %} – {{ inv.nome }}{% endif %}
                    </td>
                    <td>
                      {% if r.potencia_kw is not none %}
                        {{ '%.1f'|format(r.potencia_kw)|replace('.', ',') }}
                      {% else %}-{% endif %}
                    </td>
                    <td>
                      {% if r.etoday is not none %}
                        {{ '%.3f'|format(r.etoday)|replace('.', ',') }}
                      {% else %}-{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}

            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3 text-muted">Nenhum lançamento para o filtro atual.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
