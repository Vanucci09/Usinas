{% extends 'base.html' %}

{% block title %}Relat√≥rio de Presta√ß√£o de Contas{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 p-4 bg-white shadow rounded">
    <h2 class="text-center text-primary mb-4">üìä Relat√≥rio de Presta√ß√£o de Contas</h2>

    <!-- Filtros -->
    <form method="GET" class="row g-3 mb-4">
        <div class="col-md-4">
            <label for="acionista_id" class="form-label">Acionista</label>
            <select name="acionista_id" id="acionista_id" class="form-select" required onchange="this.form.submit()">
                <option value="">Selecione</option>
                {% for ac in acionistas %}
                    <option value="{{ ac.id }}" {% if ac.id == acionista_id %}selected{% endif %}>{{ ac.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="usina_id" class="form-label">Usina</label>
            <select name="usina_id" id="usina_id" class="form-select" onchange="this.form.submit()">
                <option value="">Todas</option>
                {% for usina in usinas %}
                    <option value="{{ usina.id }}" {% if usina.id == usina_id %}selected{% endif %}>{{ usina.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label for="mes" class="form-label">M√™s</label>
            <input type="number" min="1" max="12" class="form-control" name="mes" id="mes" value="{{ mes or '' }}">
        </div>

        <div class="col-md-2">
            <label for="ano" class="form-label">Ano</label>
            <input type="number" class="form-control" name="ano" id="ano" value="{{ ano or ano_atual }}">
        </div>

        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
    </form>

    {% if relatorio %}
    <hr>

    <!-- Desempenho da Usina -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white fw-bold">
            ‚ö° Desempenho da Usina: {{ relatorio.usina.nome }}
        </div>
        <div class="card-body">
            <p><strong>Pot√™ncia:</strong> {{ relatorio.usina.potencia_kw | default("N√£o informado") | float | round(2) | replace(".", ",") }} kW</p>
            <p><strong>Previs√£o:</strong> {{ relatorio.previsto | float | round(2) | replace(".", ",") }} kWh</p>
            <p><strong>Realizado:</strong> {{ relatorio.realizado | float | round(2) | replace(".", ",") }} kWh</p>
            <p><strong>Efici√™ncia:</strong> {{ relatorio.eficiencia }}%</p>
            <p><strong>Yield (kWh/kWp):</strong> {{ relatorio.yield_kwp if relatorio.yield_kwp is not none else 'N√£o calculado' }}</p>
        </div>
    </div>

    <!-- Fluxo do Cons√≥rcio -->
    <h5 class="mt-4 text-primary">üí∞ Fluxo Financeiro do Cons√≥rcio</h5>
    {% set total = namespace(credito=0, debito=0) %}
    <div class="table-responsive">
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th class="text-end">Cr√©dito</th>
                    <th class="text-end">D√©bito</th>
                </tr>
            </thead>
            <tbody>
                {% for item in relatorio.fluxo_consorcio %}
                {% set total.credito = total.credito + (item.credito or 0) %}
                {% set total.debito = total.debito + (item.debito or 0) %}
                <tr>
                    <td>{{ item.data.strftime('%d/%m/%Y') if item.data else '-' }}</td>
                    <td>{{ item.descricao }}</td>
                    <td class="text-end">{{ item.credito | formato_brasileiro }}</td>
                    <td class="text-end">{{ item.debito | formato_brasileiro }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="fw-bold bg-light">
                    <td colspan="2" class="text-end">Totais:</td>
                    <td class="text-end">{{ total.credito | formato_brasileiro }}</td>
                    <td class="text-end">{{ total.debito | formato_brasileiro }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Fluxo da Empresa -->
    <h5 class="mt-4 text-primary">üè¢ Fluxo Financeiro da Empresa</h5>
    {% set total_emp = namespace(credito=0, debito=0) %}
    <div class="table-responsive">
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th class="text-end">Cr√©dito</th>
                    <th class="text-end">D√©bito</th>
                </tr>
            </thead>
            <tbody>
                {% for item in relatorio.fluxo_empresa %}
                {% set total_emp.credito = total_emp.credito + (item.credito or 0) %}
                {% set total_emp.debito = total_emp.debito + (item.debito or 0) %}
                <tr class="{% if item.descricao == 'Receita L√≠quida do Cons√≥rcio' %}table-success{% endif %}">
                    <td>{{ item.data.strftime('%d/%m/%Y') if item.data else '-' }}</td>
                    <td><strong>{{ item.descricao }}</strong></td>
                    <td class="text-end">{{ item.credito | formato_brasileiro }}</td>
                    <td class="text-end">{{ item.debito | formato_brasileiro }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="fw-bold bg-light">
                    <td colspan="2" class="text-end">Totais:</td>
                    <td class="text-end">{{ total_emp.credito | formato_brasileiro }}</td>
                    <td class="text-end">{{ total_emp.debito | formato_brasileiro }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Distribui√ß√£o -->
    <div class="card my-4">
        <div class="card-header bg-info text-white fw-bold">üìà Distribui√ß√£o</div>
        <div class="card-body">
            {% for dist in relatorio.distribuicao %}
            <p>{{ dist.acionista }} - {{ dist.percentual }}% ‚Üí <strong>{{ dist.valor | formato_brasileiro }}</strong></p>
            {% endfor %}
        </div>
    </div>

    <!-- Consolida√ß√£o -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white fw-bold">üìä Consolida√ß√£o Financeira</div>
        <div class="card-body">
            <ul class="mb-0">
                <li><strong>Receita Bruta:</strong> {{ relatorio.consolidacao.receita_bruta | formato_brasileiro }}</li>
                <li><strong>Despesa Bruta:</strong> {{ relatorio.consolidacao.despesa_bruta | formato_brasileiro }}</li>
                <li><strong>Receita L√≠quida:</strong> {{ relatorio.consolidacao.receita_liquida | formato_brasileiro }}</li>
                <li><strong>Distribui√ß√£o Mensal:</strong> {{ relatorio.consolidacao.distribuicao_mensal | formato_brasileiro }}</li>
                <li><strong>Retorno Bruto:</strong> {{ relatorio.consolidacao.retorno_bruto | formato_brasileiro }}</li>
                <li><strong>Impostos:</strong> {{ relatorio.consolidacao.impostos | formato_brasileiro }}</li>
                <li><strong>Fundo Reserva:</strong> {{ relatorio.consolidacao.fundo_reserva | formato_brasileiro }}</li>
                <li><strong>Total Distribu√≠do:</strong> {{ relatorio.consolidacao.total_distribuido | formato_brasileiro }}</li>
            </ul>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}
