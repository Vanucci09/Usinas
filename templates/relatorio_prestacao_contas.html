<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Presta√ß√£o de Contas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        h4 {
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 6px;
            margin-top: 40px;
        }
        .section-card {
            background-color: #f9f9f9;
            border-left: 5px solid #0d6efd;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .card-title i {
            margin-right: 8px;
        }
        .table th {
            background-color: #e9f1ff;
        }
    </style>
</head>
<body class="bg-light">

<div class="container my-5">
    <h2 class="text-center text-primary mb-5">üìÑ Relat√≥rio de Presta√ß√£o de Contas</h2>

    <!-- Filtros -->
    <form method="GET" class="row g-3 mb-5">
        <div class="col-md-3">
            <label for="mes" class="form-label">M√™s</label>
            <select name="mes" id="mes" class="form-select">
                <option value="">Todos</option>
                {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ "{:02d}".format(m) }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="ano" class="form-label">Ano</label>
            <select name="ano" id="ano" class="form-select">
                <option value="">Todos</option>
                {% for a in range(2022, ano_atual + 1) %}
                    <option value="{{ a }}" {% if a == ano %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-6">
            <label for="acionista_id" class="form-label">Selecione o Acionista</label>
            <select name="acionista_id" id="acionista_id" class="form-select" required>
                <option value="">Selecione</option>
                {% for ac in acionistas %}
                    <option value="{{ ac.id }}" {% if ac.id == acionista_id %}selected{% endif %}>{{ ac.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="usina_id" class="form-label">Selecione a Usina</label>
            <select name="usina_id" id="usina_id" class="form-select" required>
                <option value="">Selecione</option>
                {% for u in usinas %}
                    <option value="{{ u.id }}" {% if u.id == usina_id %}selected{% endif %}>{{ u.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary px-5">
                <i class="bi bi-bar-chart-fill"></i> Gerar Relat√≥rio
            </button>
        </div>
    </form>

    {% if relatorio %}
    <div class="bg-white p-4 rounded shadow-sm">

        <!-- Usina -->
        <div class="section-card">
            <h5><i class="bi bi-lightning-charge-fill"></i> Dados da Usina</h5>
            <p><strong>Nome:</strong> {{ relatorio.usina.nome }}</p>
            <p><strong>Pot√™ncia:</strong> {{ relatorio.usina.potencia_kw }} kW</p>
            <p><strong>Data de Liga√ß√£o:</strong>
                {% if relatorio.usina.data_ligacao %}
                    {{ relatorio.usina.data_ligacao.strftime('%d/%m/%Y') }}
                {% else %}
                    N√£o informada
                {% endif %}
            </p>
            <p><strong>Gera√ß√£o Prevista:</strong> {{ relatorio.previsto }} kWh</p>
            <p><strong>Gera√ß√£o Realizada:</strong> {{ "%.2f"|format(relatorio.realizado) }} kWh</p>
            <p><strong>Efici√™ncia:</strong> {{ relatorio.eficiencia }}%</p>
        </div>

        <!-- Fluxo do Cons√≥rcio -->
        <h4><i class="bi bi-cash-coin"></i> Fluxo Financeiro do Cons√≥rcio</h4>
        <table class="table table-bordered table-sm">
            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Cr√©dito</th><th>D√©bito</th></tr></thead>
            <tbody>
                {% for item in relatorio.fluxo_consorcio %}
                <tr>
                    <td>{{ item.data.strftime('%d/%m/%Y') }}</td>
                    <td>{{ item.descricao }}</td>
                    <td>{{ item.credito | formato_brasileiro }}</td>
                    <td>{{ item.debito | formato_brasileiro }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Fluxo da Empresa -->
        <h4><i class="bi bi-building"></i> Fluxo Financeiro da Empresa Investidora</h4>
        <table class="table table-bordered table-sm">
            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Cr√©dito</th><th>D√©bito</th></tr></thead>
            <tbody>
                {% for item in relatorio.fluxo_empresa %}
                <tr>
                    <td>{{ item.data.strftime('%d/%m/%Y') }}</td>
                    <td>{{ item.descricao }}</td>
                    <td>{{ item.credito | formato_brasileiro }}</td>
                    <td>{{ item.debito | formato_brasileiro }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Lucros -->
        <h4><i class="bi bi-piggy-bank-fill"></i> Distribui√ß√£o de Lucros</h4>
        <table class="table table-bordered table-sm">
            <thead><tr><th>Acionista</th><th>% Participa√ß√£o</th><th>Valor</th></tr></thead>
            <tbody>
                {% for dist in relatorio.distribuicao %}
                <tr>
                    <td>{{ dist.acionista }}</td>
                    <td>{{ dist.percentual }}%</td>
                    <td>{{ dist.valor | formato_brasileiro }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Consolida√ß√£o -->
        <h4><i class="bi bi-journal-check"></i> Consolida√ß√£o Financeira</h4>
        <ul class="list-group mb-5">
            <li class="list-group-item"><strong>Receita Bruta:</strong> {{ relatorio.consolidacao.receita_bruta | formato_brasileiro }}</li>
            <li class="list-group-item"><strong>Despesa Bruta:</strong> {{ relatorio.consolidacao.despesa_bruta | formato_brasileiro }}</li>
            <li class="list-group-item"><strong>Receita L√≠quida:</strong> {{ relatorio.consolidacao.receita_liquida | formato_brasileiro }}</li>
            <li class="list-group-item"><strong>Distribui√ß√£o Mensal:</strong> {{ relatorio.consolidacao.distribuicao_mensal | formato_brasileiro}}</li>
            <li class="list-group-item"><strong>Retorno Bruto Mensal:</strong> {{ relatorio.consolidacao.retorno_bruto | formato_brasileiro }}</li>
            <li class="list-group-item"><strong>Impostos:</strong> {{ relatorio.consolidacao.impostos | formato_brasileiro}}</li>
            <li class="list-group-item"><strong>Fundo Reserva:</strong> {{ relatorio.consolidacao.fundo_reserva | formato_brasileiro}}</li>
            <li class="list-group-item"><strong>Total Distribu√≠do Acumulado:</strong> {{ relatorio.consolidacao.total_distribuido | formato_brasileiro}}</li>
        </ul>

    </div>
    {% endif %}
</div>

<script>
    document.getElementById('acionista_id').addEventListener('change', function () {
        const acionistaId = this.value;
        window.location.href = `?acionista_id=${acionistaId}`;
    });
</script>

</body>
</html>
