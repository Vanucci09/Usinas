{% extends 'base.html' %}
{% block title %}Editar Lançamento{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <h2 class="text-primary mb-0">Editar Lançamento #{{ titulo.id }}</h2>
    {% if titulo.aprovado %}
      <span class="badge bg-primary"><i class="bi bi-shield-check me-1"></i> Aprovado</span>
    {% endif %}
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mb-2">{{ message|safe }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if titulo.aprovado %}
    <div class="alert alert-info d-flex align-items-center" role="alert">
      <i class="bi bi-info-circle me-2"></i>
      Este lançamento está <strong>aprovado</strong>. As alterações estão bloqueadas.
    </div>
  {% endif %}

  <form method="POST"
        action="{{ url_for('empresa_financeiro_editar', lanc_id=titulo.id) }}"
        enctype="multipart/form-data">
    <input type="hidden" name="next" value="{{ request.args.get('next','') }}"/>

    <div class="row g-3">

      <!-- Empresa -->
      <div class="col-md-4">
        <label for="empresa_id" class="form-label">Empresa *</label>
        <select name="empresa_id" id="empresa_id" class="form-select" required {{ 'disabled' if titulo.aprovado }}>
          {% for emp in empresas %}
            <option value="{{ emp.id }}" {% if emp.id == titulo.empresa_id %}selected{% endif %}>{{ emp.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Tipo -->
      <div class="col-md-4">
        <label for="tipo" class="form-label">Tipo *</label>
        <select name="tipo" id="tipo" class="form-select" required {{ 'disabled' if titulo.aprovado }}>
          <option value="despesa"  {% if titulo.tipo=='despesa' %}selected{% endif %}>Despesa</option>
          <option value="receita"  {% if titulo.tipo=='receita' %}selected{% endif %}>Receita</option>
        </select>
      </div>

      <!-- Data (emissão) -->
      <div class="col-md-4">
        <label for="data" class="form-label">Data (emissão) *</label>
        <input type="date" name="data" id="data" class="form-control"
               value="{{ titulo.data.isoformat() }}" required {{ 'readonly disabled' if titulo.aprovado }}>
        {% if not titulo.aprovado %}
          <small class="text-muted">Data do título (emissão).</small>
        {% endif %}
      </div>

      <!-- Descrição -->
      <div class="col-md-8">
        <label for="descricao" class="form-label">Descrição *</label>
        <input type="text" name="descricao" id="descricao" class="form-control"
               value="{{ titulo.descricao }}" required {{ 'readonly disabled' if titulo.aprovado }}>
      </div>

      <!-- Valor -->
      <div class="col-md-4">
        <label for="valor" class="form-label">Valor (R$) *</label>
        <input type="text" name="valor" id="valor" class="form-control"
               value="{{ '{:,.2f}'.format(titulo.valor or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}"
               required {{ 'readonly disabled' if titulo.aprovado }}>
        <small class="text-muted">Use vírgula como separador decimal (ex.: 1.234,56).</small>
      </div>

      <!-- NF/Recibo -->
      <div class="col-md-4">
        <label for="numero_documento" class="form-label">NF/Recibo (nº)</label>
        <input type="text" name="numero_documento" id="numero_documento" class="form-control"
               value="{{ titulo.numero_documento or '' }}"
               placeholder="Ex.: 12345, R-2025/007, NFe 55-000123" {{ 'readonly disabled' if titulo.aprovado }}>
      </div>

      <!-- Credor (apenas para DESPESA) -->
      <div class="col-md-6" id="grupo-credor">
        <label for="credor_id" class="form-label">Credor *</label>
        <select name="credor_id" id="credor_id" class="form-select" {{ 'disabled' if titulo.aprovado }}>
          <option value="">Selecione um credor...</option>
          {% for cr in credoresent %}
            <option value="{{ cr.id }}" {% if titulo.credor_id == cr.id %}selected{% endif %}>{{ cr.nome }}</option>
          {% endfor %}
        </select>
        <small class="text-muted">Obrigatório para despesas.</small>
      </div>

      <!-- Plano Financeiro -->
      <div class="col-md-6">
        <label for="plano_financeiro_id" class="form-label">Plano Financeiro</label>
        <select name="plano_financeiro_id" id="plano_financeiro_id" class="form-select" {{ 'disabled' if titulo.aprovado }}>
          <option value="">(opcional) selecionar um plano</option>
          {% for p in planos_all %}
            <option value="{{ p.id }}" {% if titulo.plano_financeiro_id == p.id %}selected{% endif %}>{{ p.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Centro de Custo -->
      <div class="col-md-6">
        <label for="centro_custo_id" class="form-label">Centro de Custo</label>
        <select name="centro_custo_id" id="centro_custo_id" class="form-select" {{ 'disabled' if titulo.aprovado }}>
          <option value="">(opcional) selecionar centro</option>
          {% for cc in centros_all %}
            <option value="{{ cc.id }}"
                    data-empresa="{{ cc.empresa_id }}"
                    {% if titulo.centro_custo_id == cc.id %}selected{% endif %}>
              {{ cc.codigo }} — {{ cc.nome }}
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">A lista é filtrada pela empresa selecionada.</small>
      </div>

      <!-- Status -->
      <div class="col-md-4">
        <label for="status" class="form-label">Status *</label>
        <select name="status" id="status" class="form-select" required {{ 'disabled' if titulo.aprovado }}>
          <option value="pendente" {% if titulo.status=='pendente' %}selected{% endif %}>Pendente</option>
          <option value="pago"     {% if titulo.status=='pago' %}selected{% endif %}>Pago</option>
          <option value="recebido" {% if titulo.status=='recebido' %}selected{% endif %}>Recebido</option>
        </select>
      </div>

      <!-- Data vencimento/pagamento/recebimento -->
      <div class="col-md-4">
        <label for="data_vencimento" class="form-label">Data de vencimento / pgto / recebimento</label>
        <input type="date" name="data_vencimento" id="data_vencimento" class="form-control"
               value="{{ titulo.data_vencimento.isoformat() if titulo.data_vencimento else '' }}">
        <small id="helpVenc" class="text-muted d-block">Editável apenas quando o status estiver em “Pendente”.</small>
      </div>

      <!-- Conta -->
      <div class="col-md-4">
        <label for="conta_id" class="form-label">Conta (Caixa/Banco)</label>
        <select name="conta_id" id="conta_id" class="form-select" {{ 'disabled' if titulo.aprovado }}>
          <option value="">(opcional) escolher conta</option>
          {% for c in contas_all %}
            <option value="{{ c.id }}" data-empresa="{{ c.empresa_id }}"
              {% if titulo.conta_id == c.id %}selected{% endif %}>
              [{{ c.id }}] {{ c.nome }} – ({{ c.banco or 'Conta' }})
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">Obrigatório apenas se marcar como pago/recebido.</small>
      </div>

            <!-- Comprovante (LEGADO: 1 arquivo) -->
      <div class="col-md-6">
        <label class="form-label d-block">Comprovante (arquivo único – legado)</label>

        {% if titulo.comprovante_arquivo %}
          <div class="mb-2 d-flex align-items-center gap-2">
            <a href="{{ url_for('download_comprovante', filename=titulo.comprovante_arquivo) }}"
               class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener">
              <i class="bi bi-paperclip me-1"></i> Abrir atual
            </a>
            <span class="text-muted small">{{ titulo.comprovante_arquivo }}</span>
          </div>
        {% else %}
          <div class="text-muted mb-2">Nenhum comprovante (legado) anexado.</div>
        {% endif %}

        <input type="file" name="comprovante" id="comprovante" class="form-control"
               accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.heic,.heif" {{ 'disabled' if titulo.aprovado }}>
        <small class="text-muted">Se enviar um arquivo aqui, o comprovante único legado será substituído.</small>
      </div>

      <!-- Anexos (NOVO: N arquivos) -->
      <div class="col-md-6">
        <label class="form-label d-block">Anexos do Título (múltiplos)</label>

        {% set anexos = titulo.anexos or [] %}
        {% if anexos|length > 0 %}
          <ul class="list-group mb-2">
            {% for ax in anexos %}
              <li class="list-group-item d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 text-truncate" style="max-width: 70%">
                  <i class="bi bi-file-earmark"></i>
                  <a href="{{ url_for('download_anexo', anexo_id=ax.id) }}"
                     class="text-decoration-none text-break" target="_blank" rel="noopener"
                     title="{{ ax.original_name or ax.filename }}">
                    {{ ax.original_name or ax.filename }}
                  </a>
                </div>

                {% if not titulo.aprovado %}
                  <div class="form-check m-0">
                    <input class="form-check-input" type="checkbox"
                           name="remover_anexo_ids[]" value="{{ ax.id }}" id="rm-{{ ax.id }}">
                    <label class="form-check-label small" for="rm-{{ ax.id }}">remover</label>
                  </div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted mb-2">Nenhum anexo múltiplo cadastrado.</div>
        {% endif %}

        {% if not titulo.aprovado %}
          <input type="file" name="comprovantes[]" id="comprovantes" class="form-control"
                 multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.heic,.heif">
          <small class="text-muted">
            Você pode selecionar vários arquivos de uma vez. Tipos permitidos: PDF/JPG/PNG/GIF/WEBP/HEIC.
          </small>
        {% else %}
          <input type="file" class="form-control" disabled>
          <small class="text-muted">Lançamento aprovado: inclusão/remoção de anexos está bloqueada.</small>
        {% endif %}
      </div>

    </div>

    <div class="d-flex flex-column flex-md-row justify-content-end align-items-stretch gap-2 mt-4">
      <a href="{{ request.args.get('next') or url_for('empresa_financeiro_listar') }}"
         class="btn btn-outline-secondary d-flex align-items-center w-100 w-md-auto">
        <i class="bi bi-arrow-left me-2"></i> Voltar
      </a>

      {% if not titulo.aprovado %}
        <button type="submit" class="btn btn-success d-flex align-items-center w-100 w-md-auto">
          <i class="bi bi-check2-circle me-2"></i> Salvar Alterações
        </button>
      {% else %}
        <button type="button" class="btn btn-success w-100 w-md-auto" disabled>
          <i class="bi bi-check2-circle me-2"></i> Salvar Alterações
        </button>
      {% endif %}
    </div>
  </form>
</div>

<script>
  const empresaSel  = document.getElementById('empresa_id');
  const contaSel    = document.getElementById('conta_id');
  const centroSel   = document.getElementById('centro_custo_id');
  const statusSel   = document.getElementById('status');
  const tipoSel     = document.getElementById('tipo');
  const dtVenc      = document.getElementById('data_vencimento');
  const helpVenc    = document.getElementById('helpVenc');
  const grupoCredor = document.getElementById('grupo-credor');
  const credorSel   = document.getElementById('credor_id');

  function filtrarPorEmpresa(selectEl) {
    if (!empresaSel || !selectEl) return;
    const emp = (empresaSel.value || '').toString();
    for (const opt of selectEl.options) {
      if (!opt.value) { opt.hidden = false; opt.disabled = false; continue; }
      const eId = (opt.getAttribute('data-empresa') || '').toString();
      const deveOcultar = !!emp && eId !== emp;
      opt.hidden = deveOcultar;
      opt.disabled = deveOcultar;
    }
    const cur = selectEl.options[selectEl.selectedIndex];
    if (cur && (cur.hidden || cur.disabled)) {
      let escolhido = '';
      for (const opt of selectEl.options) {
        if (opt.value && !opt.hidden && !opt.disabled) { escolhido = opt.value; break; }
      }
      selectEl.value = escolhido;
    }
  }
  function filtrarContas()  { filtrarPorEmpresa(contaSel); }
  function filtrarCentros() { filtrarPorEmpresa(centroSel); }

  // Mostra/oculta e exige credor quando tipo=despesa
  function toggleCredor() {
    const isDespesa = (tipoSel ? tipoSel.value : '{{ titulo.tipo }}') === 'despesa';
    if (grupoCredor) {
      grupoCredor.style.display = isDespesa ? '' : 'none';
    }
    if (credorSel) {
      credorSel.required = isDespesa && {{ 'false' if titulo.aprovado else 'true' }};
      credorSel.disabled = {{ 'true' if titulo.aprovado else 'false' }};
      if (!isDespesa) credorSel.value = '';
    }
  }

  // Habilita edição do vencimento somente quando status = pendente e não aprovado
  function toggleVencimentoEdit() {
    const aprovado = {{ 'true' if titulo.aprovado else 'false' }};
    const s = statusSel ? statusSel.value : 'pendente';
    const canEdit = !aprovado && s === 'pendente';
    if (dtVenc) {
      dtVenc.disabled = !canEdit;
      dtVenc.readOnly = !canEdit;
    }
    if (helpVenc) {
      helpVenc.textContent = canEdit
        ? 'Editável porque o status está “Pendente”.'
        : 'Editável apenas quando o status estiver em “Pendente”.';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    filtrarContas(); filtrarCentros();
    empresaSel && empresaSel.addEventListener('change', () => {
      filtrarContas(); filtrarCentros();
    });

    statusSel && statusSel.addEventListener('change', toggleVencimentoEdit);
    toggleVencimentoEdit();

    // Tipo -> mostra/oculta credor
    tipoSel && tipoSel.addEventListener('change', toggleCredor);
    toggleCredor();
  });
</script>
{% endblock %}
