{% extends 'base.html' %}

{% block title %}Monitoramento – {{ usina.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3 text-primary">Monitoramento – {{ usina.nome }}</h2>

  <!-- Filtros -->
  <form class="row g-3 align-items-end mb-4" method="get">
    <div class="col-md-3">
      <label class="form-label">Visão</label>
      <select name="view" class="form-select">
        <option value="ultimos" {{ 'selected' if view=='ultimos' else '' }}>Últimos por inversor</option>
        <option value="diario"  {{ 'selected' if view=='diario'  else '' }}>Diário (por data)</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" name="data" value="{{ data_ref.strftime('%Y-%m-%d') }}" class="form-control">
    </div>
    <div class="col-md-3">
      <button type="submit" class="btn btn-primary">Aplicar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('monitoramento_usina', usina_id=usina.id) }}">Hoje</a>
    </div>
  </form>

  <!-- Cards de métricas rápidas -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1">{{ total }}</div>
          <div class="text-muted">Inversores cadastrados</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1">{{ online_cnt }}</div>
          <div class="text-success">Online</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1">{{ comunicando_cnt }}</div>
          <div class="text-info">Comunicando</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cadastro único do inversor -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Cadastrar inversor (uma única vez)</div>
    <div class="card-body">
      <form method="post">
        <input type="hidden" name="action" value="cad_inversor">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Serial (inverter_sn) *</label>
            <input type="text" name="inverter_sn" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Nome (opcional)</label>
            <input type="text" name="nome" class="form-control" placeholder="ex.: Inversor 01">
          </div>
          <div class="col-md-2">
            <label class="form-label">Potência (kW)</label>
            <input type="number" step="0.001" name="potencia_kw" class="form-control" placeholder="ex.: 5.0">
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-success">Salvar cadastro</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lançamento diário -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Lançar geração diária</div>
    <div class="card-body">
      {% if inversores %}
      <form method="post">
        <input type="hidden" name="action" value="salvar_monitoramento">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Inversor cadastrado *</label>
            <select name="inverter_sn" class="form-select" required>
              <option value="">Selecione...</option>
              {% for inv in inversores %}
                <option value="{{ inv.inverter_sn }}">
                  {{ inv.inverter_sn }}{% if inv.nome %} – {{ inv.nome }}{% endif %}
                  {% if inv.potencia_kw is not none %} ({{ '%.3f'|format(inv.potencia_kw) }} kW){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Data</label>
            <input type="date" name="data" value="{{ data_ref.strftime('%Y-%m-%d') }}" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">eToday (kWh)</label>
            <input type="number" step="0.001" name="etoday" class="form-control" placeholder="ex.: 21.3">
          </div>
          <div class="col-md-2 form-check mt-4 ms-2">
            <input class="form-check-input" type="checkbox" id="online" name="online">
            <label class="form-check-label" for="online">Online</label>
          </div>
          <div class="col-md-2 form-check mt-4">
            <input class="form-check-input" type="checkbox" id="comunicando" name="comunicando">
            <label class="form-check-label" for="comunicando">Comunicando</label>
          </div>
          <div class="col-md-12">
            <label class="form-label">Mensagem de erro</label>
            <input type="text" name="mensagem_erro" class="form-control" placeholder="(opcional)">
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-primary">Salvar</button>
        </div>
      </form>
      {% else %}
        <div class="alert alert-warning mb-0">
          Nenhum inversor cadastrado. Cadastre um inversor acima para lançar a geração.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Serial</th>
          <th>Potência (kW)</th>
          <th>Data</th>
          <th>eToday (kWh)</th>
          <th>Online</th>
          <th>Comunicando</th>
          <th>Mensagem</th>
        </tr>
      </thead>
      <tbody>
        {% for r in registros %}
          {% set row_class =
              'table-success' if r.online and r.comunicando else
              ('table-warning' if r.comunicando and not r.online else
               ('table-danger' if not r.comunicando else '')) %}
          <tr class="{{ row_class }}">
            <td class="fw-semibold">{{ r.inverter_sn }}</td>
            <td>{{ '%.3f'|format(r.potencia_kw) if r.potencia_kw is not none else '-' }}</td>
            <td>{{ r.data.strftime('%d/%m/%Y') }}</td>
            <td>{{ '%.3f'|format(r.etoday) if r.etoday is not none else '-' }}</td>
            <td>
              {% if r.online %}
                <span class="badge bg-success">Online</span>
              {% else %}
                <span class="badge bg-secondary">Offline</span>
              {% endif %}
            </td>
            <td>
              {% if r.comunicando %}
                <span class="badge bg-info text-dark">OK</span>
              {% else %}
                <span class="badge bg-danger">Falha</span>
              {% endif %}
            </td>
            <td>{{ r.mensagem_erro or '-' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="7" class="text-center text-muted py-4">Nenhum registro encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
