{% extends 'base.html' %}

{% block title %}Monitoramento – {{ usina.nome }}{% endblock %}

{% block content %}
{# --- Helper de formatação BR (milhares com ponto, decimal com vírgula) --- #}
{% macro fmt_kwh(v, casas=3) -%}
  {%- if v is not none -%}
    {{ ('{:,.%df}' % casas).format(v).replace(',', 'X').replace('.', ',').replace('X', '.') }}
  {%- else -%}-{% endif -%}
{%- endmacro %}

<div class="container mt-4">
  <h2 class="mb-3 text-primary">Monitoramento – {{ usina.nome }}</h2>

  {# Mensagens flash #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mb-2">{{ message|safe }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ===================== TABELA NO TOPO (ISOLADA) ===================== #}
  <form class="row g-3 align-items-end mb-3" method="get">
    {# preserva a visão e demais filtros do restante da página #}
    <input type="hidden" name="view" value="{{ view }}">
    <input type="hidden" name="data" value="{{ data_ref.strftime('%Y-%m-%d') }}">
    <input type="hidden" name="data_ini" value="{{ data_ini.strftime('%Y-%m-%d') if data_ini }}">
    <input type="hidden" name="data_fim" value="{{ data_fim.strftime('%Y-%m-%d') if data_fim }}">
    {% for sn in inv_sns %}
      <input type="hidden" name="inv" value="{{ sn }}">
    {% endfor %}

    <div class="col-md-3">
      <label class="form-label">Dia (tabela)</label>
      <input type="date" name="data_tab" value="{{ data_tab_ref.strftime('%Y-%m-%d') }}" class="form-control">
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary">Aplicar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('monitoramento_usina', usina_id=usina.id) }}">Hoje</a>
    </div>
    <div class="col-md-6 text-md-end">
      <small class="text-muted">Índice calculado com base apenas nos registros do dia da tabela.</small>
    </div>
  </form>

  {# Card do Índice % #}
  <div class="row g-3 mb-2">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Índice da usina no dia</div>
            <div class="fs-4">{{ '%.1f'|format(indice_usina_pct) }}%</div>
          </div>
          <div class="progress mt-2" style="height:10px;">
            <div class="progress-bar" role="progressbar"
                 style="width: {{ indice_usina_pct|round(1) }}%;"
                 aria-valuenow="{{ indice_usina_pct|round(1) }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <small class="text-muted">Pondera desempenho relativo, potência e status (online/comunicando).</small>
        </div>
      </div>
    </div>
  </div>

  {# Tabela (ordenada por eToday desc para ranking) #}
  <div class="table-responsive mb-4">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:70px">#</th>
          <th>Serial</th>
          <th>Potência (kW)</th>
          <th>Data</th>
          <th>eToday (kWh)</th>
          <th>Online</th>
          <th>Comunicando</th>
          <th>Mensagem</th>
        </tr>
      </thead>
      <tbody>
        {% for r in registros_tab_sorted %}
          {% set row_class =
              'table-success' if r.online and r.comunicando else
              ('table-warning' if r.comunicando and not r.online else
              ('table-danger' if not r.comunicando else '')) %}
          <tr class="{{ row_class }}">
            <td class="fw-semibold">
              {{ loop.index }}
              {% if r.id not in latest_ids %}
                <span class="badge bg-light text-muted border ms-1">antigo</span>
              {% endif %}
            </td>
            <td class="fw-semibold">{{ r.inverter_sn }}</td>
            <td>{{ fmt_kwh(r.potencia_kw, 3) if r.potencia_kw is not none else '-' }}</td>
            <td>{{ r.data.strftime('%d/%m/%Y') }}</td>

            {# eToday só no snapshot mais recente por SN #}
            <td>
              {% if r.id in latest_ids %}
                {% set e = latest_etoday_por_sn.get(r.inverter_sn) %}
                {{ fmt_kwh(e, 3) if e is not none else '-' }}
              {% else %}
                -
              {% endif %}
            </td>

            <td>
              {% if r.online %}<span class="badge bg-success">Online</span>
              {% else %}<span class="badge bg-secondary">Offline</span>{% endif %}
            </td>
            <td>
              {% if r.comunicando %}<span class="badge bg-info text-dark">OK</span>
              {% else %}<span class="badge bg-danger">Falha</span>{% endif %}
            </td>
            <td>{{ r.mensagem_erro or '-' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="8" class="text-center text-muted py-4">Nenhum registro encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# ===================== RESTANTE DA PÁGINA (cards, filtros, gráficos) ===================== #}

  <!-- Filtros básicos (visão + data para a listagem/visão abaixo) -->
  <form class="row g-3 align-items-end mb-4" method="get">
    <div class="col-md-3">
      <label class="form-label">Visão</label>
      <select name="view" class="form-select">
        <option value="ultimos" {{ 'selected' if view=='ultimos' else '' }}>Últimos por inversor</option>
        <option value="diario"  {{ 'selected' if view=='diario'  else '' }}>Diário (por data)</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" name="data" value="{{ data_ref.strftime('%Y-%m-%d') }}" class="form-control">
    </div>
    <div class="col-md-3">
      <button type="submit" class="btn btn-outline-primary">Aplicar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('monitoramento_usina', usina_id=usina.id) }}">Hoje</a>
    </div>
    {# preserva dia da tabela ao reaplicar filtros gerais #}
    <input type="hidden" name="data_tab" value="{{ data_tab_ref.strftime('%Y-%m-%d') }}">
    {% for sn in inv_sns %}
      <input type="hidden" name="inv" value="{{ sn }}">
    {% endfor %}
    <input type="hidden" name="data_ini" value="{{ data_ini.strftime('%Y-%m-%d') if data_ini }}">
    <input type="hidden" name="data_fim" value="{{ data_fim.strftime('%Y-%m-%d') if data_fim }}">
  </form>

  <!-- Cards de métricas rápidas -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm"><div class="card-body text-center">
        <div class="fs-1">{{ total }}</div>
        <div class="text-muted">Inversores cadastrados</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm"><div class="card-body text-center">
        <div class="fs-1">{{ online_cnt }}</div>
        <div class="text-success">Online</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm"><div class="card-body text-center">
        <div class="fs-1">{{ comunicando_cnt }}</div>
        <div class="text-info">Comunicando</div>
      </div></div>
    </div>
  </div>

  <!-- Filtros extras para gráficos/comparação -->
  <form class="row g-3 align-items-end mb-4" method="get">
    <input type="hidden" name="view" value="{{ view }}">
    <input type="hidden" name="data" value="{{ data_ref.strftime('%Y-%m-%d') }}">
    <input type="hidden" name="data_tab" value="{{ data_tab_ref.strftime('%Y-%m-%d') }}">
    <div class="col-md-3">
      <label class="form-label">Período – Início</label>
      <input type="date" name="data_ini" value="{{ data_ini.strftime('%Y-%m-%d') if data_ini }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Período – Fim</label>
      <input type="date" name="data_fim" value="{{ data_fim.strftime('%Y-%m-%d') if data_fim }}" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">Inversores (comparação)</label>
      <select name="inv" class="form-select" multiple size="6">
        {% for inv in inversores %}
          <option value="{{ inv.inverter_sn }}" {% if inv.inverter_sn in inv_sns %}selected{% endif %}>
            {{ inv.inverter_sn }}{% if inv.nome %} – {{ inv.nome }}{% endif %}
          </option>
        {% endfor %}
      </select>
      <small class="text-muted">Segure Ctrl/Cmd para selecionar vários.</small>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Aplicar</button>
    </div>
  </form>

  <!-- KPIs do período selecionado -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm"><div class="card-body text-center">
        <div class="fs-3">{{ kpi_periodo.dias }}</div>
        <div class="text-muted">Dias no período</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm"><div class="card-body text-center">
        <div class="fs-3">{{ fmt_kwh(kpi_periodo.total_periodo_kwh, 3) }}</div>
        <div class="text-muted">Total gerado (kWh)</div>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm"><div class="card-body text-center">
        <div class="fs-5">
          Melhor no período:
          {% if kpi_periodo.melhor_sn %}
            <span class="fw-semibold">{{ kpi_periodo.melhor_sn }}</span>
            ({{ fmt_kwh(kpi_periodo.melhor_total_kwh, 3) }} kWh)
          {% else %}—{% endif %}
        </div>
      </div></div>
    </div>
  </div>

  <!-- GRÁFICOS -->
  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header">eToday por dia (comparação)</div>
        <div class="card-body"><canvas id="chartLine"></canvas></div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">Top por geração total (kWh)</div>
        <div class="card-body"><canvas id="chartBarTop"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header">Radar de métricas (média, pico, total)</div>
        <div class="card-body"><canvas id="chartRadar"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header">Potência (kW) × Média diária (kWh)</div>
        <div class="card-body"><canvas id="chartScatter"></canvas></div>
      </div>
    </div>
  </div>
</div>

{# === SCRIPTS (Chart.js) === #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Dados do servidor p/ gráficos
  const LABELS = {{ chart_labels|tojson }};
  const SERIES = {{ chart_series|tojson }};
  const TOP_LABELS = {{ top_labels|tojson }};
  const TOP_DATA = {{ top_data|tojson }};
  const RADAR_LABELS = {{ radar_labels|tojson }};
  const RADAR_SERIES = {{ radar_series|tojson }};
  const SCATTER_POINTS = {{ scatter_points|tojson }};

  function makeColor(i){ const r=(137*i)%255,g=(97*i)%255,b=(197*i)%255; return `rgba(${r}, ${g}, ${b}, 0.8)`; }

  // Linha
  const dsLine = SERIES.map((s,i)=>({label:s.label,data:s.data,tension:0.25,fill:false,borderColor:makeColor(i),backgroundColor:makeColor(i),pointRadius:2}));
  new Chart(document.getElementById('chartLine'),{
    type:'line',
    data:{labels:LABELS,datasets:dsLine},
    options:{interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom'}},scales:{y:{title:{display:true,text:'kWh (eToday)'}},x:{title:{display:true,text:'Dia'}}}}
  });

  // Barras
  new Chart(document.getElementById('chartBarTop'),{
    type:'bar',
    data:{labels:TOP_LABELS,datasets:[{label:'Total no período (kWh)',data:TOP_DATA}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'kWh'}}}}
  });

  // Radar
  const dsRadar = RADAR_SERIES.map((s,i)=>({label:s.label,data:s.data,backgroundColor:makeColor(i).replace('0.8','0.2'),borderColor:makeColor(i)}));
  new Chart(document.getElementById('chartRadar'),{type:'radar',data:{labels:RADAR_LABELS,datasets:dsRadar},options:{elements:{line:{borderWidth:2}},plugins:{legend:{position:'bottom'}}}});

  // Scatter
  new Chart(document.getElementById('chartScatter'),{
    type:'scatter',
    data:{datasets:[{label:'Inversores',data:SCATTER_POINTS,parsing:{xAxisKey:'x',yAxisKey:'y'},showLine:false,pointRadius:4}]},
    options:{plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>{const p=ctx.raw; return `${p.label}: Pot ${p.x} kW • Média ${Number(p.y).toFixed(3)} kWh/d`;}}}},scales:{x:{title:{display:true,text:'Potência (kW)'}},y:{title:{display:true,text:'Média diária (kWh)'}}}}
  });
</script>
{% endblock %}
