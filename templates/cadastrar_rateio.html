{% extends 'base.html' %}

{% block title %}Cadastrar Rateio{% endblock %}

{% block content %}
<div class="container mt-5 p-4 bg-white rounded shadow">
    <h2 class="mb-4 text-primary text-center">Cadastrar Rateio</h2>

    <form method="POST" action="{{ url_for('cadastrar_rateio') }}">
        <div class="mb-3">
            <label for="usina_id" class="form-label">Usina</label>
            <select class="form-select" id="usina_id" name="usina_id" required onchange="carregarClientes()">
                <option value="" disabled selected>Selecione a usina</option>
                {% for usina in usinas %}
                    <option value="{{ usina.id }}">{{ usina.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="cliente_id" class="form-label">Cliente</label>
            <select class="form-select" id="cliente_id" name="cliente_id" required>
                <option value="">Selecione uma usina primeiro</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="percentual" class="form-label">% da Energia</label>
            <input type="number" step="0.01" class="form-control" id="percentual" name="percentual" required>
        </div>

        <!-- MODO DE TARIFA -->
        <div class="mb-3">
            <label class="form-label">Modo de Tarifa</label>
            <div class="d-flex gap-3 flex-wrap">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="modo_tarifa" id="modo_fixo" value="fixo" checked onchange="toggleModoTarifa()">
                    <label class="form-check-label" for="modo_fixo">Tarifa fixa (digitar)</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="radio" name="modo_tarifa" id="modo_neo" value="neo" onchange="toggleModoTarifa()">
                    <label class="form-check-label" for="modo_neo">Tarifa = Neoenergia com desconto</label>
                </div>
            </div>
        </div>

        <!-- BLOCO FIXO -->
        <div class="mb-3" id="bloco_tarifa_fixa">
            <label for="tarifa_kwh" class="form-label">Tarifa por kWh (R$)</label>
            <input type="number" step="0.0000001" class="form-control" id="tarifa_kwh" name="tarifa_kwh" required>
        </div>

        <!-- BLOCO NEO -->
        <div class="mb-3 d-none" id="bloco_tarifa_neo">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Tarifa Neoenergia (última fatura)</label>
                    <input type="text" class="form-control" id="tarifa_neoenergia" readonly value="—">
                </div>

                <div class="col-md-4">
                    <label for="desconto_percentual" class="form-label">Desconto (%)</label>
                    <input type="number" step="0.01" class="form-control" id="desconto_percentual" name="desconto_percentual" value="15" oninput="recalcularTarifa()">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Tarifa calculada (prévia)</label>
                    <input type="text" class="form-control" id="tarifa_calculada" readonly value="—">
                </div>
            </div>

            <div class="alert alert-info mt-3 mb-0">
                Ao salvar, o sistema grava a <strong>tarifa_kwh calculada</strong> (snapshot) para evitar NULL no banco.
            </div>
        </div>

        <div class="text-center mt-3">
            <button type="submit" class="btn btn-success">Cadastrar Rateio</button>
        </div>
    </form>

    <div class="text-center mt-4 d-flex justify-content-center gap-3 flex-wrap">
        <a href="{{ url_for('listar_rateios') }}" class="btn btn-primary">
            <i class="bi bi-list-ul"></i> Ver Rateios Cadastrados
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-house-door-fill"></i> Voltar para o Início
        </a>
    </div>
</div>

<script>
let tarifaNeo = null;

function toggleModoTarifa() {
    const modoNeo = document.getElementById('modo_neo').checked;

    document.getElementById('bloco_tarifa_fixa').classList.toggle('d-none', modoNeo);
    document.getElementById('bloco_tarifa_neo').classList.toggle('d-none', !modoNeo);

    document.getElementById('tarifa_kwh').required = !modoNeo;
    document.getElementById('desconto_percentual').required = modoNeo;

    if (modoNeo) carregarTarifaNeoenergia();
}

function carregarTarifaNeoenergia() {
    if (!document.getElementById('modo_neo').checked) return;

    const usinaId = document.getElementById("usina_id").value;
    const clienteId = document.getElementById("cliente_id").value;
    if (!usinaId || !clienteId) return;

    fetch(`/api/tarifa_neoenergia?usina_id=${encodeURIComponent(usinaId)}&cliente_id=${encodeURIComponent(clienteId)}`)
        .then(r => r.json())
        .then(resp => {
            if (!resp || resp.ok !== true) return;
            tarifaNeo = resp.tarifa_neoenergia;

            document.getElementById('tarifa_neoenergia').value =
                (tarifaNeo === null || tarifaNeo === undefined) ? 'Sem fatura' : Number(tarifaNeo).toFixed(7);

            recalcularTarifa();
        })
        .catch(() => {});
}

function recalcularTarifa() {
    if (!document.getElementById('modo_neo').checked) return;

    const out = document.getElementById('tarifa_calculada');

    if (tarifaNeo === null || tarifaNeo === undefined) {
        out.value = '—';
        return;
    }

    const descPct = parseFloat(document.getElementById('desconto_percentual').value || '0');
    const calculada = Number(tarifaNeo) * (1 - (descPct / 100));
    out.value = calculada.toFixed(7);
}

function carregarClientes() {
    const usinaId = document.getElementById("usina_id").value;
    const clienteSelect = document.getElementById("cliente_id");
    clienteSelect.innerHTML = '<option value="">Carregando...</option>';

    fetch(`/cadastrar_rateio?ajax=1&usina_id=${encodeURIComponent(usinaId)}`)
        .then(response => response.json())
        .then(data => {
            clienteSelect.innerHTML = "";
            if (!data || data.length === 0) {
                clienteSelect.innerHTML = '<option value="">Nenhum cliente disponível</option>';
                return;
            }

            const defaultOption = document.createElement("option");
            defaultOption.textContent = "Selecione o cliente";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            clienteSelect.appendChild(defaultOption);

            data.forEach(cliente => {
                const option = document.createElement("option");
                option.value = cliente.id;
                option.textContent = `${cliente.nome} (ID: ${cliente.id})`;
                clienteSelect.appendChild(option);
            });

            // ao trocar cliente, atualiza tarifa se estiver no modo Neo
            clienteSelect.onchange = () => {
                if (document.getElementById('modo_neo').checked) carregarTarifaNeoenergia();
            };
        })
        .catch(() => {
            clienteSelect.innerHTML = '<option value="">Erro ao carregar clientes</option>';
        });
}

// estado inicial
toggleModoTarifa();
</script>

{% endblock %}
