{% extends 'base.html' %}
{% block title %}Cadastrar Centro de Custo{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-primary mb-3">Cadastrar Centro de Custo</h2>

  <form method="POST">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Empresa</label>
        <select name="empresa_id" id="empresa_id" class="form-select" required>
            <option value="">Selecione...</option>
            {% for e in empresas %}
            <option value="{{ e.id }}">{{ e.nome }}</option>
            {% endfor %}
        </select>
        </div>

        <div class="col-md-6">
        <label class="form-label">Cliente Operacional</label>
        <select name="cliente_id" id="cliente_id" class="form-select" required disabled>
            <option value="">Selecione a empresa primeiro...</option>
        </select>
        </div>

      <div class="col-md-4">
        <label class="form-label">Código</label>
        <input type="text" name="codigo" class="form-control" required>
      </div>

      <div class="col-md-8">
        <label class="form-label">Nome do Centro de Custo</label>
        <input type="text" name="nome" class="form-control" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">CPF/CNPJ</label>
        <input type="text" name="cpf_cnpj" class="form-control">
      </div>

      <div class="col-md-8">
        <label class="form-label">Endereço</label>
        <input type="text" name="endereco" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Telefone</label>
        <input type="text" name="telefone" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input type="email" name="email" class="form-control">
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-success">Salvar</button>
      <a href="{{ url_for('listar_centros_custos') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
(async function () {
  const empresaSel = document.getElementById('empresa_id');
  const clienteSel = document.getElementById('cliente_id');

  async function carregaClientes(empresaId) {
    clienteSel.innerHTML = '<option value="">Carregando...</option>';
    clienteSel.disabled = true;
    if (!empresaId) {
      clienteSel.innerHTML = '<option value="">Selecione a empresa primeiro...</option>';
      return;
    }
    try {
      const resp = await fetch(`/api/empresas/${empresaId}/clientes`);
      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        clienteSel.innerHTML = '<option value="">Nenhum cliente para esta empresa</option>';
        return;
      }
      clienteSel.innerHTML = '<option value="">Selecione...</option>';
      for (const c of data) {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nome;
        clienteSel.appendChild(opt);
      }
      clienteSel.disabled = false;
    } catch (e) {
      clienteSel.innerHTML = '<option value="">Erro ao carregar</option>';
    }
  }

  empresaSel.addEventListener('change', () => carregaClientes(empresaSel.value));
})();
</script>
{% endblock %}
