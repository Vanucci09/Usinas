<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Faturamento</title>
    <meta name="viewport" content="width=850">
    <link href="file://{{ bootstrap_path }}" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            width: 850px;
            margin: auto;
        }
        .card-relatorio {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        .logo {
            height: 40px;
            max-width: 120px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            margin-bottom: 20px;
        }
        .info-block {
            font-size: 14px;
            line-height: 1.4;
            flex: 1;
        }
        .info-block strong {
            display: block;
            font-weight: bold;
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
        }
        .valor {
            font-size: 22px;
            font-weight: bold;
            color: #2e7d32;
        }
        .tabela {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .tabela th, .tabela td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .bg-light-yellow {
            background-color: #fffbe6;
        }
        .bg-light-green {
            background-color: #e9f7ef;
        }
        .economia {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .economia .col {
            flex: 1;
            text-align: center;
        }
        .icon {
            font-size: 24px;
        }
    </style>
</head>
<body>

<div class="card-relatorio">
    <!-- Cabe√ßalho -->
    <div class="header">
        <img src="{{ logo_cgr_path }}" class="logo" alt="Logo CGR">
        <h2 style="flex: 1; text-align: center;">Relat√≥rio de Faturamento {{ usina.nome }}</h2>
        {% if logo_usina_path %}
            <img src="{{ logo_usina_path }}" class="logo" alt="Logo Usina">
        {% endif %}
    </div>

    <!-- Informa√ß√µes principais -->
    <div class="info-row">
        <div class="info-block">
            <strong>Nome / Raz√£o:</strong> {{ cliente.nome }}
            <strong>Endere√ßo:</strong> {{ cliente.endereco }}
            <strong>CNPJ:</strong> {{ cliente.cpf_cnpj }}
        </div>
        <div class="info-block" style="text-align: right;">
            <strong>M√™s de Refer√™ncia:</strong> {{ fatura.mes_referencia }}/{{ fatura.ano_referencia }}
            <strong>ID:</strong> {{ fatura.identificador }}
            <strong>UC:</strong> {{ cliente.codigo_unidade }}
            <strong>Bandeira Tarif√°ria:</strong> Verde
        </div>
    </div>

    <!-- Tabela -->
    <div class="section-title text-center">Informa√ß√µes da unidade consumidora</div>
    <table class="tabela">
        <thead>
            <tr>
                <th>Descri√ß√£o</th>
                <th>Quantidade</th>
                <th>Unidade</th>
                <th>Tarifa R$</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Energia Ativa</td>
                <td>{{ fatura.consumo_total }}</td>
                <td>kWh</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Energia Injetada</td>
                <td>{{ fatura.injetado }}</td>
                <td>kWh</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Faturado Neoenergia</td>
                <td>{{ fatura.consumo_neoenergia }}</td>
                <td>kWh</td>
                <td>{{ tarifa_neoenergia_aplicada|formato_tarifa }}</td>
            </tr>
            <tr>
                <td>Faturado {{ usina.nome }}</td>
                <td>{{ "%.1f"|format(fatura.consumo_usina) }}</td>
                <td>kWh</td>
                <td>{{ tarifa_cliente|formato_tarifa }}</td>
            </tr>

            {# ‚úÖ Linha extra: Custo TUSD Fio B (mostra apenas quando aplic√°vel) #}
            {% if usina.tusd_fio_b and (fatura.custo_tusd_fio_b or 0) != 0 %}
            <tr>
                <td>Custo TUSD Fio B</td>
                <td>‚Äî</td>
                <td>‚Äî</td>
                <td>{{ (fatura.custo_tusd_fio_b or 0) | formato_brasileiro }}</td>
            </tr>
            {% endif %}

            {% if cliente.mostrar_saldo and fatura.saldo_unidade %}
            <tr>
                <td>Saldo Acumulado</td>
                <td>{{ fatura.saldo_unidade }}</td>
                <td>kWh</td>
                <td>-</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- NOVA SE√á√ÉO: Gera√ß√£o da Usina no Per√≠odo -->
    {% if cliente.consumo_instantaneo and geracao_periodo %}
        <div class="section-title text-center">Gera√ß√£o da Usina no Per√≠odo</div>
        <table class="tabela">
            <thead>
                <tr>
                    <th>Per√≠odo</th>
                    <th>Gera√ß√£o</th>
                    <th>Unidade</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ fatura.inicio_leitura.strftime('%d/%m/%Y') }} a {{ fatura.fim_leitura.strftime('%d/%m/%Y') }}</td>
                    <td>{{ geracao_periodo }} kWh</td>
                    <td>kWh</td>
                </tr>
            </tbody>
        </table>
    {% endif %}

    <!-- Contas -->
    <div class="contas" style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
        <div style="
            background-color: #fffbe6;
            border-radius: 8px;
            padding: 20px;
            min-width: 250px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        ">
            <p style="margin: 0; font-weight: bold;">Conta Neoenergia:</p>
            <p class="valor" style="margin: 0;">{{ fatura.valor_conta_neoenergia|formato_brasileiro }}</p>
        </div>

        <div style="
            background-color: #e9f7ef;
            border-radius: 8px;
            padding: 20px;
            min-width: 250px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        ">
            <p style="margin: 0; font-weight: bold;">Conta {{ usina.nome }}:</p>
            <p class="valor" style="margin: 0;">{{ valor_usina|formato_brasileiro }}</p>
        </div>
    </div>

    <!-- Economia -->
    <div class="section-title text-center">Sua Fatura {{ usina.nome }}</div>
    <div class="economia">
        <div class="col">
            <div class="icon text-warning">üí∞</div>
            <p><strong>Sem Desconto:</strong></p>
            <p class="valor">{{ sem_desconto|formato_brasileiro }}</p>
        </div>
        <div class="col">
            <div class="icon text-success">üíµ</div>
            <p><strong>Com Desconto:</strong></p>
            <p class="valor">{{ com_desconto|formato_brasileiro }}</p>
        </div>
        <div class="col">
            <div class="icon text-dark">üè¶</div>
            <p><strong>Economia:</strong></p>
            <p class="valor">{{ economia|formato_brasileiro }}</p>
        </div>
        <div class="col">
            <div class="icon text-dark">üìà</div>
            <p><strong>Economia Acumulada:</strong></p>
            <p class="valor">{{ economia_acumulada|formato_brasileiro }}</p>
        </div>

        {# ‚úÖ Nova coluna: % de Desconto #}
        <div class="col">
            <div class="icon text-primary">üéØ</div>
            <p><strong>% Desconto:</strong></p>
            {% set perc_desc = (economia / sem_desconto * 100) if sem_desconto else 0 %}
            <p class="valor">
                {{ "%.2f"|format(perc_desc)|replace('.', ',') }}%
            </p>
        </div>
    </div>

    <!-- Ficha de compensa√ß√£o -->
    {% if ficha_compensacao_path %}
        <hr class="my-5">
        <h5 class="text-center text-secondary">Ficha de Compensa√ß√£o</h5>
        <div style="display: flex; justify-content: center; margin-top: 20px;">
            <img src="{{ ficha_compensacao_path }}" style="max-width: 100%; width: auto;" alt="Ficha de Compensa√ß√£o">
        </div>
    {% endif %}
</div>

</body>
</html>
