{% extends 'base.html' %}

{% block content %}

<div class="container my-5">
  <div class="bg-white p-4 rounded shadow-sm">

    <h2 class="text-center text-primary mb-4">
      Editar Usina - {{ usina.nome }}
    </h2>

    <!-- Seleção de ano -->
    <form method="GET" class="row g-3 align-items-end mb-4">
      <div class="col-auto">
        <label for="ano" class="form-label">Selecionar Ano:</label>
        <input type="number" id="ano" name="ano" value="{{ ano }}" class="form-control">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary">Carregar</button>
      </div>
    </form>

    <!-- FORM PRINCIPAL -->
    <form method="POST" enctype="multipart/form-data" class="row g-3">

      <!-- DADOS GERAIS -->
      <div class="col-md-6">
        <label class="form-label">Código CC:</label>
        <input type="text" name="cc" class="form-control" value="{{ usina.cc }}" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Nome da Usina:</label>
        <input type="text" name="nome" class="form-control" value="{{ usina.nome }}" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Potência (kW):</label>
        <input type="number" step="0.01" name="potencia_kw"
               class="form-control" value="{{ usina.potencia_kw }}">
      </div>

      <div class="col-md-4">
        <label class="form-label">Data de Ligação:</label>
        <input type="date" name="data_ligacao"
               class="form-control"
               value="{{ usina.data_ligacao.strftime('%Y-%m-%d') if usina.data_ligacao }}">
      </div>

      <div class="col-md-4">
        <label class="form-label">Valor Investido (R$):</label>
        <input type="number" step="0.01" name="valor_investido"
               class="form-control"
               value="{{ usina.valor_investido }}">
      </div>

      <div class="col-12">
        <label class="form-label">Saldo Atual (kWh)</label>
        <input type="text" name="saldo_kwh"
               class="form-control"
               value="{{ usina.saldo_kwh or '' }}">
      </div>

      <div class="col-12 mt-2">
        <input type="hidden" name="tusd_fio_b" value="0">
        <div class="form-check form-check-inline">
          <input type="checkbox" name="tusd_fio_b" value="1"
                 class="form-check-input"
                 {% if usina.tusd_fio_b %}checked{% endif %}>
          <label class="form-check-label">TUSD Fio B</label>
        </div>

        <input type="hidden" name="boleto_proprio" value="0">
        <div class="form-check form-check-inline">
          <input type="checkbox" name="boleto_proprio" value="1"
                 class="form-check-input"
                 {% if usina.boleto_proprio %}checked{% endif %}>
          <label class="form-check-label">Boleto Próprio</label>
        </div>
      </div>

      <!-- LOGO -->
      {% if usina.logo_url %}
      <div class="col-md-6">
        <label class="form-label">Logo Atual:</label><br>
        <img src="{{ url_for('servir_logo', nome_arquivo=usina.logo_url) if env == 'production'
                     else url_for('static', filename='logos/' + usina.logo_url) }}"
             class="img-fluid border rounded"
             style="max-height:100px;">
      </div>
      {% endif %}

      <div class="col-md-6">
        <label class="form-label">Nova Logo (opcional):</label>
        <input type="file" name="logo" class="form-control">
      </div>

      <!-- PREVISÕES -->
      <div class="col-12 mt-4">
        <label class="form-label">Previsão Mensal (kWh)</label>
        <div class="row g-3">
          {% set meses = [
            'Jan','Fev','Mar','Abr','Mai','Jun',
            'Jul','Ago','Set','Out','Nov','Dez'
          ] %}
          {% for i in range(12) %}
          <div class="col-md-4">
            <label class="form-label">{{ meses[i] }}</label>
            <input type="number" step="0.01"
                   name="previsoes[{{ i+1 }}]"
                   class="form-control"
                   value="{{ previsoes.get(i+1, '') }}">
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- CONFIGURAÇÃO DA FICHA -->
      <div class="col-12 mt-5">
        <hr>
        <h5 class="text-primary">Configuração da Ficha de Compensação</h5>
        <small class="text-muted">Percentuais de 0 a 1 (ex: 0.37 = 37%).</small>
      </div>

      <div class="col-md-3">
        <label class="form-label">DPI (Padrão)</label>
        <input type="number" name="ficha_dpi_padrao"
               class="form-control"
               value="{{ usina.ficha_dpi_padrao }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">DPI (Boleto)</label>
        <input type="number" name="ficha_dpi_boleto"
               class="form-control"
               value="{{ usina.ficha_dpi_boleto }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Página (Padrão)</label>
        <select name="ficha_page_select_padrao" class="form-select">
            <option value="first"
                {% if usina.ficha_page_select_padrao == 'first' %}selected{% endif %}>
                Primeira Página
            </option>

            <option value="last"
                {% if usina.ficha_page_select_padrao == 'last' %}selected{% endif %}>
                Última Página
            </option>

            <option value="0"
                {% if usina.ficha_page_select_padrao == '0' %}selected{% endif %}>
                Página 1
            </option>

            <option value="1"
                {% if usina.ficha_page_select_padrao == '1' %}selected{% endif %}>
                Página 2
            </option>

            <option value="2"
                {% if usina.ficha_page_select_padrao == '2' %}selected{% endif %}>
                Página 3
            </option>

            <option value="-1"
                {% if usina.ficha_page_select_padrao == '-1' %}selected{% endif %}>
                Última (index -1)
            </option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Página (Boleto)</label>
        <select name="ficha_page_select_boleto" class="form-select">
            <option value="first"
                {% if usina.ficha_page_select_boleto == 'first' %}selected{% endif %}>
                Primeira Página
            </option>

            <option value="last"
                {% if usina.ficha_page_select_boleto == 'last' %}selected{% endif %}>
                Última Página
            </option>

            <option value="0"
                {% if usina.ficha_page_select_boleto == '0' %}selected{% endif %}>
                Página 1
            </option>

            <option value="1"
                {% if usina.ficha_page_select_boleto == '1' %}selected{% endif %}>
                Página 2
            </option>

            <option value="2"
                {% if usina.ficha_page_select_boleto == '2' %}selected{% endif %}>
                Página 3
            </option>

            <option value="-1"
                {% if usina.ficha_page_select_boleto == '-1' %}selected{% endif %}>
                Última (index -1)
            </option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Top % (Padrão)</label>
        <input type="number" step="0.001"
               name="ficha_crop_padrao_top"
               class="form-control"
               value="{{ usina.ficha_crop_padrao_top }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Bottom % (Padrão)</label>
        <input type="number" step="0.001"
               name="ficha_crop_padrao_bottom"
               class="form-control"
               value="{{ usina.ficha_crop_padrao_bottom }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Top % (Boleto)</label>
        <input type="number" step="0.001"
               name="ficha_crop_boleto_top"
               class="form-control"
               value="{{ usina.ficha_crop_boleto_top }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Bottom % (Boleto)</label>
        <input type="number" step="0.001"
               name="ficha_crop_boleto_bottom"
               class="form-control"
               value="{{ usina.ficha_crop_boleto_bottom }}">
      </div>

      <!-- TESTE DE FICHA -->
      <div class="col-12 mt-4">
        <hr>
        <h5 class="text-primary">Testar Recorte</h5>

        <div class="mb-3">
          <label class="form-label">PDF para Teste</label>
          <input type="file" name="pdf_teste"
                 accept="application/pdf"
                 class="form-control">
        </div>
      </div>

      <!-- BOTÕES -->
      <div class="col-12 text-center mt-4">
        <button type="submit"
                class="btn btn-primary px-4">
          Salvar Alterações
        </button>

        <button type="submit"
                formaction="{{ url_for('testar_ficha_usina', usina_id=usina.id, ano=ano) }}"
                formmethod="POST"
                formenctype="multipart/form-data"
                class="btn btn-outline-primary px-4 ms-2">
          Salvar e Gerar Preview
        </button>
      </div>

    </form>

    <!-- PREVIEW -->
    {% if preview_url %}
    <div class="mt-5 text-center">
      <h5 class="text-success">Preview do Recorte</h5>
      <img src="{{ preview_url }}?v={{ preview_cache_bust }}"
           class="img-fluid border rounded mt-3"
           style="max-height:500px;">
    </div>
    {% endif %}

    <div class="text-center mt-4">
      <a href="/usinas" class="btn btn-outline-secondary">Voltar</a>
    </div>

  </div>
</div>

{% endblock %}