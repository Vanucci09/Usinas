<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Produção Mensal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-in-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="container mt-5">

    <h2 class="mb-4 text-primary">Produção Mensal - {{ usina_nome }}</h2>

    <!-- Filtro -->
    <form class="row g-3 mb-4" method="get" onsubmit="irParaProducao(event)">
        <div class="col-md-4">
            <label for="usina_id" class="form-label">Usina</label>
            <select class="form-select" id="usina_id" required>
                <option value="">Selecione</option>
                {% for usina in usinas %}
                    <option value="{{ usina.id }}" {% if usina_id|int == usina.id %}selected{% endif %}>{{ usina.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="ano" class="form-label">Ano</label>
            <input type="number" class="form-control" id="ano" value="{{ ano }}" required>
        </div>
        <div class="col-md-2">
            <label for="mes" class="form-label">Mês</label>
            <input type="number" class="form-control" id="mes" value="{{ mes }}" min="1" max="12" required>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
    </form>

    <!-- Totais em cartões com ícones -->
{% set totais_faturamento = {'bruto': 0, 'liquido': 0, 'geracao_total': 0} %}
{% for item in detalhes %}
    {% set faturamento = item.energia_kwh * 0.83 %}
    {% set liquido = faturamento * 0.80 %}
    {% set _ = totais_faturamento.update({
        'bruto': totais_faturamento.bruto + faturamento,
        'liquido': totais_faturamento.liquido + liquido,
        'geracao_total': totais_faturamento.geracao_total + item.energia_kwh
    }) %}
{% endfor %}

<div class="row mb-5">
    <div class="col-md-4 fade-in">
        <div class="card border-warning shadow-sm">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-lightning-charge text-warning fs-1 me-3"></i>
                <div>
                    <h5 class="card-title text-warning">Geração Total</h5>
                    <p class="card-text fs-4">{{ totais_faturamento.geracao_total }} kWh</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 fade-in" style="animation-delay: 0.2s;">
        <div class="card border-success shadow-sm">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-currency-dollar text-success fs-1 me-3"></i>
                <div>
                    <h5 class="card-title text-success">Previsão Faturamento Bruto</h5>
                    <p class="card-text fs-4">{{ totais_faturamento.bruto | formato_brasileiro }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 fade-in" style="animation-delay: 0.4s;">
        <div class="card border-primary shadow-sm">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-cash-stack text-primary fs-1 me-3"></i>
                <div>
                    <h5 class="card-title text-primary">Previsão Valor Líquido</h5>
                    <p class="card-text fs-4">{{ totais_faturamento.liquido | formato_brasileiro }}</p>
                </div>
            </div>
        </div>
    </div>    
</div>


    <!-- Gráfico -->
    <canvas id="graficoProducao" height="100"></canvas>

    <!-- Informações -->
    <div class="mt-5">
        <div class="alert alert-info">
            <strong>Geração total até agora:</strong> {{ soma_total }} kWh<br>
            <strong>Média diária atual:</strong> {{ media_diaria }} kWh<br>
            <strong>Previsão para o mês inteiro:</strong> {{ previsao_total }} kWh
        </div>
    </div>

    <!-- Tabela -->
    <div class="mt-4">
        <h5>Detalhes Diários</h5>
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>Data</th>
                    <th>Energia Gerada (kWh)</th>
                    <th>Faturamento Bruto</th>
                    <th>Valor Líquido</th>
                </tr>
            </thead>
            <tbody>
                {% for item in detalhes %}
                    {% set faturamento = item.energia_kwh * 0.83 %}
                    {% set liquido = faturamento * 0.80 %}
                    <tr>
                        <td>{{ item.data }}</td>
                        <td>{{ item.energia_kwh }}</td>
                        <td>{{ faturamento|formato_brasileiro }}</td>
                        <td>{{ liquido|formato_brasileiro }}</td>
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-light">
                <tr>
                    <th colspan="2">Totais</th>
                    <th>{{ totais_faturamento.bruto|formato_brasileiro }}</th>
                    <th>{{ totais_faturamento.liquido|formato_brasileiro }}</th>
                </tr>
            </tfoot>
        </table>
    </div>

    <a href="/consulta" class="btn btn-secondary mt-4">Voltar</a>

    <!-- Gráfico com cores baseadas na média -->
    <script>
        const mediaDiaria = {{ media_diaria | tojson }};
        const dias = {{ meses | tojson }};
        const producao = {{ totais | tojson }};

        const cores = producao.map(valor =>
            valor < mediaDiaria ? 'rgba(255, 99, 132, 0.6)' : 'rgba(54, 162, 235, 0.6)'
        );
        const bordas = producao.map(valor =>
            valor < mediaDiaria ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)'
        );

        const ctx = document.getElementById('graficoProducao').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dias,
                datasets: [{
                    label: 'Energia Gerada (kWh)',
                    data: producao,
                    backgroundColor: cores,
                    borderColor: bordas,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Produção Diária no Mês' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'kWh' }
                    },
                    x: {
                        title: { display: true, text: 'Dia do Mês' }
                    }
                }
            }
        });

        function irParaProducao(event) {
            event.preventDefault();
            const usina = document.getElementById('usina_id').value;
            const ano = document.getElementById('ano').value;
            const mes = document.getElementById('mes').value;
            if (usina && ano && mes) {
                window.location.href = `/producao_mensal/${usina}/${ano}/${mes}`;
            }
        }
    </script>

</body>
</html>
