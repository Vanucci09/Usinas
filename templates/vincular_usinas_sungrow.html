{% extends 'base.html' %}

{% block title %}Vincular Usinas Sungrow{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">Vincular plantas Sungrow às usinas do sistema</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if plantas %}
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Planta Sungrow</th>
          <th>ID Sungrow (ps_id)</th>
          <th>Capacidade</th>
          <th>Hoje (kWh)</th>
          <th>Total (MWh)</th>
          <th>Usina vinculada</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        {% for p in plantas %}
          {% set usina_vinc = mapa_ps_para_usina.get(p.ps_id|string) %}
          <tr>
            <td>{{ p.nome }}</td>
            <td>{{ p.ps_id }}</td>
            <td>
              {% if p.capacidade %}
                {{ p.capacidade }} kW
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ "%.1f"|format(p.today_kwh or 0) }}</td>
            <td>{{ "%.3f"|format(p.total_mwh or 0) }}</td>
            <td>
              {% if usina_vinc %}
                <span class="badge bg-success">{{ usina_vinc.nome }}</span>
              {% else %}
                <span class="badge bg-secondary">Nenhuma</span>
              {% endif %}
            </td>
            <td>
              <form method="post" class="d-flex gap-2">
                <input type="hidden" name="ps_id" value="{{ p.ps_id }}">
                <select name="usina_id" class="form-select form-select-sm" required>
                  <option value="">-- selecionar usina --</option>
                  {% for u in usinas %}
                    <option value="{{ u.id }}"
                      {% if usina_vinc and usina_vinc.id == u.id %}selected{% endif %}>
                      {{ u.nome }}
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary">
                  Vincular
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-warning">
      Nenhuma planta retornada da API Sungrow.
    </div>
  {% endif %}
</div>
{% endblock %}
